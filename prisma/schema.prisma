// Prisma Schema for MED DROP - Medical Courier Portal
// Database: SQLite for development (swap to PostgreSQL for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS (SQLite doesn't support enums, so we use String types)
// Valid values documented as comments:
// 
// ClientType: INDEPENDENT_PHARMACY, CLINIC, LAB, DIALYSIS_CENTER, IMAGING_CENTER, HOSPITAL, GOVERNMENT, OTHER
// FacilityType: CLINIC, LAB, HOSPITAL, PHARMACY, DIALYSIS, IMAGING, GOVERNMENT, OTHER
// ServiceType: STAT, SAME_DAY, SCHEDULED_ROUTE, OVERFLOW, GOVERNMENT
// SpecimenCategory: UN3373_CATEGORY_B, NON_SPECIMEN_MEDICAL, PHARMACEUTICAL_NON_CONTROLLED, OTHER
// TemperatureRequirement: AMBIENT, REFRIGERATED, FROZEN, OTHER
// LoadStatus: NEW, QUOTED, QUOTE_ACCEPTED, SCHEDULED, PICKED_UP, IN_TRANSIT, DELIVERED, COMPLETED, CANCELLED
// PreferredContactMethod: PHONE, EMAIL
// CreatedVia: WEB_FORM, INTERNAL
// TrackingEventCode: REQUEST_RECEIVED, PRICE_QUOTED, SHIPPER_CONFIRMED, DRIVER_EN_ROUTE_PICKUP, PICKED_UP, IN_TRANSIT, ARRIVED_AT_DESTINATION, DELIVERED, PAPERWORK_COMPLETED, CANCELLED
// DocumentType: PROOF_OF_PICKUP, PROOF_OF_DELIVERY, BILL_OF_LADING, OTHER
// UserRole: ADMIN, DISPATCHER, VIEW_ONLY
// DriverStatus: AVAILABLE, ON_ROUTE, OFF_DUTY, INACTIVE
// VehicleType: SEDAN, SUV, VAN, SPRINTER, BOX_TRUCK, REFRIGERATED
// ============================================================================

// ============================================================================
// MODELS
// ============================================================================

// Shipper: The client company requesting courier services
model Shipper {
  id           String  @id @default(cuid())
  companyName  String
  clientType   String // ClientType enum
  contactName  String
  phone        String
  email        String  @unique
  passwordHash String? // For shipper portal login
  isActive     Boolean @default(true)

  // Payment Terms & Billing
  paymentTerms        String  @default("NET_14") // NET_7, NET_14, NET_30, INVOICE_ONLY
  billingContactName  String?
  billingContactEmail String?
  billingAddressLine1 String?
  billingAddressLine2 String?
  billingCity         String?
  billingState        String?
  billingPostalCode   String?
  stripeCustomerId    String? // Optional - only if client uses Stripe ACH

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  facilities   Facility[]
  loadRequests LoadRequest[]
  invoices     Invoice[]

  @@index([email])
  @@index([companyName])
}

// Facility: Pickup or dropoff locations
model Facility {
  id                 String   @id @default(cuid())
  shipperId          String
  name               String
  facilityType       String // FacilityType enum
  addressLine1       String
  addressLine2       String?
  city               String
  state              String
  postalCode         String
  contactName        String
  contactPhone       String
  defaultAccessNotes String? // Default access instructions for this facility
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  shipper             Shipper       @relation(fields: [shipperId], references: [id], onDelete: Cascade)
  pickupLoadRequests  LoadRequest[] @relation("PickupFacility")
  dropoffLoadRequests LoadRequest[] @relation("DropoffFacility")

  @@index([shipperId])
}

// LoadRequest: The main entity representing a courier job
model LoadRequest {
  id                 String @id @default(cuid())
  publicTrackingCode String @unique // e.g., "MED-1234-AB"

  // Shipper & Facilities
  shipperId         String
  pickupFacilityId  String
  dropoffFacilityId String

  // Service Details
  serviceType            String // ServiceType enum
  commodityDescription   String // What's being shipped
  specimenCategory       String // SpecimenCategory enum
  temperatureRequirement String // TemperatureRequirement enum

  // Load Specifications (optional)
  estimatedContainers Int?
  estimatedWeightKg   Float?
  declaredValue       Float?

  // Timing
  readyTime        DateTime? // When ready for pickup
  deliveryDeadline DateTime? // Must deliver by

  // Instructions & Contact
  accessNotes            String? // Pickup/delivery access notes
  preferredContactMethod String  @default("EMAIL") // PreferredContactMethod enum

  // Status & Workflow
  status String @default("NEW") // LoadStatus enum

  // Driver Assignment
  driverId           String? // Assigned driver
  assignedAt         DateTime? // When assigned to driver
  acceptedByDriverAt DateTime? // When driver accepted

  // Signatures & Compliance
  pickupSignature    String? // Base64 signature image
  pickupSignerName   String? // Who signed at pickup
  deliverySignature  String? // Base64 signature image
  deliverySignerName String? // Who signed at delivery
  pickupAttested     Boolean @default(false) // Driver attestation checkbox at pickup
  pickupAttestedAt   DateTime? // When attestation was given
  deliveryAttested   Boolean @default(false) // Driver attestation checkbox at delivery
  deliveryAttestedAt DateTime? // When attestation was given
  signatureUnavailableReason String? // Reason if signature couldn't be captured
  signatureFallbackPhoto    String? // Base64 photo if signature unavailable

  // Temperature Tracking
  pickupTemperature   Float? // Temperature at pickup (째C)
  deliveryTemperature Float? // Temperature at delivery (째C)
  temperatureMin      Float? // Minimum acceptable temperature (째C)
  temperatureMax      Float? // Maximum acceptable temperature (째C)
  pickupTempException Boolean @default(false) // Flag if out of range at pickup
  deliveryTempException Boolean @default(false) // Flag if out of range at delivery
  temperatureExceptionNotes String? // Driver notes about temperature exceptions

  // Actual Timing
  actualPickupTime   DateTime? // Actual pickup timestamp
  actualDeliveryTime DateTime? // Actual delivery timestamp

  // Pricing/Quoting
  quoteAmount     Float?
  quoteCurrency   String    @default("USD")
  quoteNotes      String? // Internal notes about the quote
  quoteAcceptedAt DateTime? // When shipper accepted quote

  // Invoice Linking
  invoiceId  String? // Link to invoice when billed
  invoicedAt DateTime? // When invoice was generated

  // Metadata
  createdVia String   @default("WEB_FORM") // CreatedVia enum
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  shipper         Shipper         @relation(fields: [shipperId], references: [id])
  pickupFacility  Facility        @relation("PickupFacility", fields: [pickupFacilityId], references: [id])
  dropoffFacility Facility        @relation("DropoffFacility", fields: [dropoffFacilityId], references: [id])
  driver          Driver?         @relation(fields: [driverId], references: [id])
  invoice         Invoice?        @relation(fields: [invoiceId], references: [id])
  trackingEvents  TrackingEvent[]
  documents       Document[]

  @@index([driverId])
  @@index([publicTrackingCode])
  @@index([shipperId])
  @@index([status])
  @@index([createdAt])
}

// TrackingEvent: UPS-style tracking checkpoints with chain-of-custody
model TrackingEvent {
  id            String   @id @default(cuid())
  loadRequestId String
  code          String // TrackingEventCode enum - Event type code
  label         String // Human-friendly display text (e.g., "Picked up from ABC Clinic")
  description   String? // Optional detailed description
  locationText  String? // City/facility text for display
  actorId       String? // Driver ID or user ID who performed this action (chain-of-custody)
  actorType     String? // "DRIVER", "SHIPPER", "ADMIN" (chain-of-custody)
  latitude      Float? // GPS latitude (optional, for location verification)
  longitude     Float? // GPS longitude (optional, for location verification)
  createdAt     DateTime @default(now()) // Event timestamp

  // Relations
  loadRequest LoadRequest @relation(fields: [loadRequestId], references: [id], onDelete: Cascade)

  @@index([loadRequestId])
  @@index([createdAt])
  @@index([actorId])
}

// Document: Attachments for proof of pickup/delivery, BOL, etc.
model Document {
  id            String   @id @default(cuid())
  loadRequestId String
  type          String // DocumentType enum
  title         String // e.g., "Proof of Pickup - ABC Clinic"
  url           String // Storage URL (S3, etc.) or base64 data
  mimeType      String? // MIME type (image/jpeg, application/pdf, etc.)
  fileSize      Int? // File size in bytes
  uploadedBy    String? // User ID or "driver" or "shipper"
  isLocked      Boolean @default(false) // True if load is DELIVERED (POD locking)
  lockedAt      DateTime? // When document was locked
  adminOverride Boolean @default(false) // True if admin allowed late upload
  adminOverrideBy String? // Admin user ID who approved override
  adminOverrideNotes String? // Reason for override (audit log)
  createdAt     DateTime @default(now())

  // Relations
  loadRequest LoadRequest @relation(fields: [loadRequestId], references: [id], onDelete: Cascade)

  @@index([loadRequestId])
}

// Invoice: Billing invoices for completed loads
model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String @unique // Internal invoice number (e.g., "INV-2024-001")

  // Billing Details
  shipperId   String
  invoiceDate DateTime @default(now())
  dueDate     DateTime // Calculated based on payment terms

  // Amounts
  subtotal Float // Service amount before tax
  tax      Float @default(0) // Tax amount
  total    Float // Total amount due

  // Status Tracking
  status           String    @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  sentAt           DateTime? // When invoice was emailed
  paidAt           DateTime? // When payment was received
  paymentMethod    String? // ACH, CHECK, WIRE, STRIPE_ACH, OTHER
  paymentReference String? // Check number, ACH confirmation, transaction ID, etc.
  notes            String? // Internal notes about payment

  // Optional Stripe Integration (secondary, not primary)
  stripeInvoiceId String? // Stripe invoice ID if using Stripe (optional)

  // Relations
  shipper      Shipper       @relation(fields: [shipperId], references: [id])
  loadRequests LoadRequest[] // Many loads can be on one invoice

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shipperId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
  @@index([invoiceDate])
}

// Driver: Courier drivers
model Driver {
  id           String @id @default(cuid())
  firstName    String
  lastName     String
  email        String @unique
  phone        String
  passwordHash String // bcrypt hash

  // Driver Details
  licenseNumber String? // Driver's license number
  licenseExpiry DateTime? // License expiration date
  status        String    @default("AVAILABLE") // DriverStatus enum

  // Vehicle Information
  vehicleType      String? // VehicleType enum
  vehicleMake      String?
  vehicleModel     String?
  vehicleYear      Int?
  vehiclePlate     String?
  hasRefrigeration Boolean @default(false)

  // Training & Certifications
  un3373Certified   Boolean   @default(false)
  un3373ExpiryDate  DateTime?
  hipaaTrainingDate DateTime?

  // Employment
  hiredDate        DateTime?
  emergencyContact String?
  emergencyPhone   String?

  // Payment Settings (Optional - stored as strings for SQLite)
  paymentMethod      String? // ACH, CHECK, etc.
  bankName           String?
  accountHolderName  String?
  routingNumber      String?
  accountNumber      String? // Encrypted in production
  accountType        String? // checking, savings
  payoutFrequency    String? // WEEKLY, BIWEEKLY, MONTHLY
  minimumPayout      Float?  @default(100)
  taxId              String? // Encrypted in production
  taxIdType          String? // SSN, EIN
  w9Submitted        Boolean @default(false)

  // Relations
  loadRequests LoadRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
}

// User: Internal staff for admin access
model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String // bcrypt hash
  role         String   @default("DISPATCHER") // UserRole enum
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}
